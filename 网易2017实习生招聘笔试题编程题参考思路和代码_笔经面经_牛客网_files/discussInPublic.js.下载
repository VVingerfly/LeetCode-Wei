define("nowcoder/1.2.751/javascripts/site/discuss/discussInPublic",["nc","cpn","../../core/siteConfig","../../component/editorSub/hEditor","ncPlugin/kindeditor/kindeditor","../../util/uploadRemote","../../component/select","../../util/util","../../component/popupSub/popupCommon","../../action/discuss","../../util/ajax","../../action/contest","../../component/cmt/index","../../util/littleAction","../../action/note"],function(a){function b(){var a=this;A.copy(a,window,["post","comment"]),a.comment.draft=(a.comment.draft||{}).content||"",a.globalInfo=A.clone(window.globalInfo),a.initContent(),a.initTitle(),a.initCmt(),a.initEditor(),a.initShare(),a.initShowImage(),a.initHref(),a.initFollow()}function c(){var a=w("div.post-topic-main div.post-topic-des");a.find("script").remove();var b=a.html();/<.*?>/.test(b)||(b=b.replace(/^\n+/g,"").replace(/\n+$/g,"").replace(/\n+/g,"<br /><br />"),a.html(b))}function d(){function a(a){"cancel"===a?(d.removeClass("js-click-unfollow").addClass("js-click-follow").html("收藏"),e.removeClass("js-fix-unfollow link-green").addClass("js-fix-follow")):("new"===a||"edit"===a)&&(d.removeClass("js-click-follow").addClass("js-click-unfollow").html("已收藏"),e.removeClass("js-fix-follow").addClass("js-fix-unfollow link-green"))}var b=this,c=b.post,d=w(".js-click-follow, .js-click-unfollow"),e=w(".js-fix-follow, .js-fix-unfollow");N.follow({entityId:c.id,entityType:D.type.post,followCls:"js-click-follow",unfollowCls:"js-click-unfollow",followCb:a}),N.follow({entityId:c.id,entityType:D.type.post,followCls:"js-fix-follow",unfollowCls:"js-fix-unfollow",followStr:"",followedStr:"",noHover:!0,followCb:a})}function e(){var a=this,b=a.post,c=a.comment,d=w("div.js-comment-list");a.commentList=new L({renderTo:d.find(".module-body"),renderBy:"html",type:"bbs",isAdmin:b.isAdmin,currentUid:a.globalInfo.ownerId,entityId:b.id,entityType:b.entityType,pageSize:c.pageSize,page:c.curPage,autoOpenSubCmt:!0,extHeight:-1*(F.getNavHeight()+w(".js-fixed-title").outerHeight()),listeners:{listDataChange:function(a){var b=d.find("div.module-head h1");b.html(a.totalCount+"条回帖")}}});var e=B.getParam("toCommentId");e&&window.setTimeout(function(){a.commentList.scrollToId(e,!0,!0)},1e3)}function f(){var a=w("div.post-topic-des a");window.setTimeout(function(){A.forEach(a,function(a){var b=a.href;a=w(a),b=b||a.attr("href"),b&&-1!==b.indexOf("http")&&-1===b.indexOf("nowcoder.com")&&a.attr("target","_blank")})},250)}function g(a){var b=this,c=b.post,d=w(a.currentTarget);window.isLogin&&(x.mark(d)||K[c.isLiked?"unlike":"like"]({body:{id:b.post.id,type:b.post.entityType},call:function(a){var b=a.count||0;A.forEach(w(".js-post-like"),function(a){a=w(a);var d=a.text().replace(c.isLiked?"已赞":"赞",c.isLiked?"赞":"已赞").replace(/\d+/,b);a.html(d)}),w(".js-fix-like")[c.isLiked?"removeClass":"addClass"]("link-green"),c.isLiked=!c.isLiked},error:function(a){H.alert(a.msg)},always:function(){x.pause(d)}}))}function h(){if(window.isLogin){var a=w("div.editor-box").closest("div.module-box");G.scrollToEl({el:a,animation:!0,ext:-w("div.nowcoder-header").height()-10}),G.highLight({el:a})}}function i(b){var c=this,d=w(b.currentTarget);return x.mark(d)?void 0:c.post.isAdmin?void H.confirm("删除后这篇帖子将无法恢复，是否确定删除？",function(){J.deletePost({body:{id:c.post.id},call:function(){H.tips("操作成功",function(){window.location.href="/discuss"})},error:function(a){H.alert(a.msg)},always:function(){x.pause(d)}})},function(){x.clear(d)}):c.post.isGilded?void H.confirm("此帖已被设为精华供网友膜拜，还请手下留情！如果心意已决，请联系管理员删除。",function(){a.async("../../component/popupSub/popupMsg",function(a){a.show({title:"发私信",content:window.location.href,receiver:{name:"管理员",id:60},sentCb:function(){location.reload()}})})},function(){x.clear(d)}):void H.confirm("辛苦码字，删了就没啦，真的要删吗？",function(){J.deletePost({body:{id:c.post.id},call:function(){H.tips("操作成功",function(){window.location.href="/discuss"})},error:function(a){H.alert(a.msg)},always:function(){x.pause(d)}})},function(){x.clear(d)})}function j(a){var b=this,c=w(a.currentTarget),d=c.attr("data-action");if(!("top"!==d&&"untop"!==d||x.mark(c))){var e=c.attr("data-all");J[d]({body:{postId:b.post.id,isTopAll:"0"!==e},call:function(){c.attr("data-action","top"==d?"untop":"top"),c.html("0"!==e?"全站置顶"==c.text()?"取消全站置顶":"全站置顶":"置顶"==c.text()?"取消置顶":"置顶")},error:function(a){H.alert(a.msg)},always:function(){x.pause(c)}})}}function k(a){var b=this,c=w(a.currentTarget),d=c.attr("data-action");"gild"!==d&&"ungild"!==d||x.mark(c)||J[d]({body:{postId:b.post.id},call:function(){c.attr("data-action","gild"==d?"ungild":"gild"),c.html("加精"==c.text()?"取消加精":"加精")},error:function(a){H.alert(a.msg)},always:function(){x.pause(c)}})}function l(a){var b=this,c=w(a.currentTarget),d=c.attr("data-action");"sink"!==d&&"unsink"!==d||x.mark(c)||J[d]({body:{postId:b.post.id},call:function(){c.attr("data-action","sink"==d?"unsink":"sink"),c.html("下沉"==c.text()?"取消下沉":"下沉")},error:function(a){H.alert(a.msg)},always:function(){x.pause(c)}})}function m(a){var b=this,c=w(a.currentTarget),d=c.attr("data-action");if(!("dis-certify"!==d&&"certify"!==d||x.mark(c))){var e="certify"===d?1:0;J.updateCertify({body:{postId:b.post.id,certify:e},call:function(){c.attr("data-action","dis-certify"==d?"certify":"dis-certify"),c.html("取消认证"===c.text()?"认证":"取消认证")},error:function(a){H.alert(a.msg)},always:function(){x.pause(c)}})}}function n(a){var b=this,c=w(a.currentTarget),d=c.attr("data-action");if(!("dis-uncertify"!==d&&"uncertify"!==d||x.mark(c))){var e="uncertify"===d?2:0;J.updateCertify({body:{postId:b.post.id,certify:e},call:function(){c.attr("data-action","uncertify"==d?"dis-uncertify":"uncertify"),c.html("取消未认证"===c.text()?"未认证":"取消未认证")},error:function(a){H.alert(a.msg)},always:function(){x.pause(c)}})}}function o(){var b=this;0!==w("div.js-editor").length&&(b.commentIpt=new E({renderTo:w("div.js-editor"),height:180,toolbarFixedTop:F.getNavHeight(),placeholder:"在这里畅所欲言你的看法吧！",content:b.comment.draft,disabled:!window.isLogin,needChangeEditor:!0,clickMask:function(){window.isLogin||(b.commentIpt.blur(),a.async("../../component/popupSub/popupLogin",function(a){a.show({register:D.popup.showReg,loginCb:function(){window.location.reload()},registerCb:function(){window.location.reload()}})}))},draftChange:function(a){window.isLogin&&J.saveDiscussDraft({body:{entityId:b.post.id,content:a,type:D.draftType.answerPost}})},afterChangeEditor:function(a){b.commentIpt=a}}))}function p(a){var b=this,c=w(a.currentTarget);x.mark(c)||b.commentList.createCmt({content:w.trim(b.commentIpt.val()),call:function(){b.commentIpt.val("")},error:function(){},always:function(){x.pause(c)}})}function q(){var a=w("h1.discuss-title").text(),b=w("div.post-topic-des");try{b=w(b[0].cloneNode(!0)),b.find("script").remove()}catch(c){}var d="「"+a+"」 "+b.text().replace(/\r|\n/g,"");d=d.replace(/\s+/g," ");var e=d.length>100?d.substring(0,100)+"...":d;M.bind({el:w("li.oprt-item-share a.js-share-link"),title:w("h1.discuss-title").text(),desc:e,link:window.location.href}),w(".js-share-wx").on("click",function(){I.wx(z.rqUrl(window.location.href))})}function r(){function a(a){a.stopPropagation(),a.preventDefault();var b=w(a.currentTarget),c=w.trim(b.attr("src"));c&&C.show(c)}var b=w(document);b.on("click","div.post-topic-des img",a),b.on("click","div.answer-brief img",a)}function s(){function a(){window.clearTimeout(b);var a,c=e.scrollTop(),d=c+f,j=h>=c,k=d+n+1>=o+m;h=c,a=j||!g||k?j&&g?d>o&&d+n<i.offset().top:k&&d+n<i.offset().top:!0,a&&!g?(g=!0,l.fadeIn(200)):!a&&g&&(l.hide(),g=!1)}var b,c=this,d=c.post,e=w(window),f=F.getNavHeight(),g=!1,h=0,i=w("div.editor-box").closest("div.module-box"),j=w(".discuss-topic-head"),k=j.find(".discuss-title"),l=w(k.get(0).cloneNode(!0)).addClass("js-fixed-title fixed-title").css("top",f).hide().appendTo(j);l.append(y.execTpl(['<div class="discuss-tool-bar">','<a href="javascript:void(0);" class="icon-thumbs-up js-fix-like nc-req-auth #{likeCls}"></a>','<a href="javascript:void(0);" class="icon-star #{followCls}"></a>','<a href="javascript:void(0);" class="icon-comment nc-req-auth js-post-replay"></a>',"</div>"].join(""),{likeCls:d.isLiked?"link-green":"",followCls:d.isFollowed?"js-fix-unfollow link-green":"js-fix-follow"}));var m=j.outerHeight(),n=l.outerHeight(),o=j.offset().top;e.on("scroll",function(){window.clearTimeout(b),b=window.setTimeout(a,10)}),b=window.setTimeout(a,120)}function t(a){var b=this,c=(b.post,w(a.currentTarget));if(!x.mark(c)){var d=c.attr("data-action");J[d]({body:{postId:b.post.id},call:function(){c.attr("data-action","hidden"==d?"unhidden":"hidden"),c.html("隐藏"===c.text()?"取消隐藏":"隐藏")},error:function(a){H.alert(a.msg)},always:function(){x.pause(c)}})}}var u=a("nc"),v=a("cpn"),w=u.$,x=u.Limit,y=u.Str,z=u.Sys,A=u.Base,B=u.Uri,C=v.PopupImage,D=a("../../core/siteConfig"),E=a("../../component/editorSub/hEditor"),F=a("../../util/util"),G=u.Dom,H=v.Popup,I=a("../../component/popupSub/popupCommon"),J=a("../../action/discuss"),K=a("../../action/contest"),L=a("../../component/cmt/index"),M=u.Share,N=a("../../util/littleAction");z.ready({initialize:b,events:{"click .js-post-like":g,"click .js-fix-like":g,"click .js-post-replay":h,"click .js-post-del":i,"click .post-top":j,"click .post-gild":k,"click .post-certify":m,"click .post-uncertify":n,"click .post-hidden":t,"click .post-sink":l},binds:{"click #jsPubPoint":p},initContent:c,initFollow:d,initCmt:e,initHref:f,initEditor:o,initShare:q,initShowImage:r,initTitle:s})});